# group_by(input) %>%
group_modify(~ bootstrap_ci(.x, n_boot = 2000))
head(results)
library(dplyr)
library(boot)
attribution_data <- attribution_data %>% dplyr::filter(label==1)
# Define bootstrap function
boot_mean <- function(data, indices) {
d <- data[indices, ]
mean(d$attribution)
}
# Function to compute CI per input
bootstrap_ci <- function(df, n_boot = 1000, conf = 0.95) {
boot_res <- boot(df, boot_mean, R = n_boot)
ci <- boot.ci(boot_res, type = "perc", conf = conf)
data.frame(
mean = mean(df$attribution),
lower = ci$percent[4],
upper = ci$percent[5]
)
}
# Apply bootstrap per input
results <- attribution_data %>%
group_by(input) %>%
group_modify(~ bootstrap_ci(.x, n_boot = 2000)) %>%
ungroup()
library(dplyr)
library(boot)
attribution_data <- attribution_data %>% dplyr::filter(label==1)
bootstrap_ci <- function(df, n_boot = 2000, conf = 0.95) {
x <- df$attribution
m <- mean(x)
n <- length(x)
s <- sd(x)
# not enough data to estimate CI
if (n < 2) {
return(tibble::tibble(mean = m, lower = NA_real_, upper = NA_real_,
n = n, sd = s, note = "n<2"))
}
# all values identical -> zero-width CI at the mean
if (isTRUE(all.equal(s, 0))) {
return(tibble::tibble(mean = m, lower = m, upper = m,
n = n, sd = s, note = "sd=0"))
}
# otherwise try bootstrap percentile CI
boot_mean <- function(data, indices) mean(data[indices])
boot_res <- boot(x, boot_mean, R = n_boot)
ci <- tryCatch(
boot.ci(boot_res, type = "perc", conf = conf),
error = function(e) NULL
)
if (!is.null(ci) && !is.null(ci$percent)) {
tibble::tibble(mean = m, lower = ci$percent[4], upper = ci$percent[5],
n = n, sd = s, note = "bootstrap-perc")
} else {
# fallback: t-based CI
alpha <- 1 - conf
half_width <- qt(1 - alpha/2, df = n - 1) * s / sqrt(n)
tibble::tibble(mean = m, lower = m - half_width, upper = m + half_width,
n = n, sd = s, note = "t-fallback")
}
}
results <- attribution_data %>%
group_by(input) %>%
group_modify(~ bootstrap_ci(.x, n_boot = 2000, conf = 0.95)) %>%
ungroup()
head(results)
View(results)
library(boot)
bootstrap_ci <- function(x, n_boot = 2000, conf = 0.95) {
# if not enough variation, return NA or zero-width CI
if (length(unique(x)) < 2) {
return(tibble::tibble(
mean = mean(x),
lower = NA_real_,
upper = NA_real_,
ci_size = NA_real_
))
}
# define bootstrap function
boot_mean <- function(data, indices) mean(data[indices])
boot_res <- boot(x, boot_mean, R = n_boot)
ci <- boot.ci(boot_res, type = "perc", conf = conf)
tibble::tibble(
mean = mean(x),
lower = ci$percent[4],
upper = ci$percent[5],
ci_size = ci$percent[5] - ci$percent[4]
)
}
df_token_stats <- attribution_data %>%
filter(label == 1) %>%
group_by(input) %>%
summarise(
stats = list(bootstrap_ci(attribution, n_boot = 2000, conf = 0.95))
) %>%
tidyr::unnest(stats)
View(df_token_stats)
golem::add_module(name = "attrib_bar_plot")
View(attribution_data)
View(attribution_data)
ggplot2::ggplot(attribution_data, ggplot2::aes(x = attribution, y=input)) +
ggplot2::geom_bar(
position = "identity",
alpha = 0.6,
color = "black",
bins = 30
)
ggplot2::ggplot(attribution_data, ggplot2::aes(x = attribution, y=input)) +
ggplot2::geom_bar(
)
ggplot2::ggplot(attribution_data, ggplot2::aes(x = attribution, y=input)) +
ggplot2::geom_bar(
stat = "identity"
)
View(attribution_data)
View(attribution_data)
barplot_data <- attribution_data %>%
dplyr::arrange(attribution) %>%
top_n(10)
View(barplot_data)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y=input)) +
ggplot2::geom_bar(
stat = "identity"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y= reorder(input, -attribution))) +
ggplot2::geom_bar(
stat = "identity"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y= reorder(input, attribution))) +
ggplot2::geom_bar(
stat = "identity"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y= reorder(input, attribution))) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
)
runApp()
runApp()
runApp()
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution))) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("Positive" = "#ff7f0e"),
labels = "Positive"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("Positive" = "#ff7f0e"),
labels = "Positive"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c(1 = "#ff7f0e"),
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e"),
labels = "Positive"
)
barplot_data <- attribution_data %>%
dplyr::arrange(attribution) %>%
top_n(10) %>%
dplyr::mutate(label= as.character(label))
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e"),
labels = "Positive"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e")
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e")
) +
ggplot2::labs(
x = "Attribution score",
y = "Frequency",
title = "Token attributions for class 'Positive'"
) +
ggplot2::theme_minimal(base_size = 12) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
legend.title = ggplot2::element_blank(),
legend.position="bottom"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e")
) +
ggplot2::labs(
x = "Attribution score",
y = "Frequency",
title = "Token attributions for class 'Positive'"
) +
ggplot2::theme_minimal(base_size = 12) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
legend.title = ggplot2::element_blank(),
legend.position="none"
)
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e")
) +
ggplot2::labs(
x = "Attribution score",
y = "Top 10 tokens",
title = "Token attributions for class 'Positive'"
) +
ggplot2::theme_minimal(base_size = 12) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
legend.title = ggplot2::element_blank(),
legend.position="none"
)
shiny::runApp()
barplot_data <- attribution_data %>%
dplyr::arrange(attribution) %>%
top_n(10) %>%
dplyr::mutate(label= as.character(label))
db_path <- system.file("extdata", "eir_data.sqlite", package = "DNBCFoodTextClassifier")
con <- DBI::dbConnect(RSQLite::SQLite(), db_path)
classif_type="Broad Categories"
food_category="Alcohol"
if (!exists("food_category") || is.null(food_category) || food_category == "" || is.na(food_category)) {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type, "'")
} else {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type,
"' AND name_exp = '", food_category, "'")
}
category_id <- DBI::dbGetQuery(con, q1)$category_id
q2 <- paste0("SELECT * FROM attributions WHERE category_id IN (", paste(category_id, collapse = ","),")")
attribution_data <- DBI::dbGetQuery(con, q2)
View(attribution_data)
barplot_data <- attribution_data %>%
dplyr::filter(label==1)
dplyr::arrange(attribution) %>%
top_n(10) %>%
dplyr::mutate(label= as.character(label))
barplot_data <- attribution_data %>%
dplyr::filter(label==1) %>%
dplyr::arrange(attribution) %>%
top_n(10) %>%
dplyr::mutate(label= as.character(label))
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e")
) +
ggplot2::labs(
x = "Attribution score",
y = "Top 10 tokens",
title = "Token attributions for class 'Positive'"
) +
ggplot2::theme_minimal(base_size = 12) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
legend.title = ggplot2::element_blank(),
legend.position="none"
)
barplot_data <- attribution_data %>%
dplyr::filter(label==1) %>%
dplyr::arrange(attribution) %>%
top_n(10) %>%
dplyr::mutate(label= as.character(label))
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e", "0" = "#1f77b4")
) +
ggplot2::labs(
x = "Attribution score",
y = "Top 10 tokens",
title = "Token attributions for class 'Positive'"
) +
ggplot2::theme_minimal(base_size = 12) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
legend.title = ggplot2::element_blank(),
legend.position="none"
)
shiny::runApp()
db_path <- system.file("extdata", "eir_data.sqlite", package = "DNBCFoodTextClassifier")
con <- DBI::dbConnect(RSQLite::SQLite(), db_path)
classif_type="Broad Categories"
food_category="Alcohol"
if (!exists("food_category") || is.null(food_category) || food_category == "" || is.na(food_category)) {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type, "'")
} else {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type,
"' AND name_exp = '", food_category, "'")
}
category_id <- DBI::dbGetQuery(con, q1)$category_id
q2 <- paste0("SELECT * FROM attributions WHERE category_id IN (", paste(category_id, collapse = ","),")")
attribution_data <- DBI::dbGetQuery(con, q2)
barplot_data <- attribution_data %>%
dplyr::filter(label==1) %>%
dplyr::arrange(attribution) %>%
top_n(10) %>%
dplyr::mutate(label= as.character(label))
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e", "0" = "#1f77b4")
) +
ggplot2::labs(
x = "Attribution score",
y = "Top 10 tokens",
title = "Token attributions for class 'Positive'"
) +
ggplot2::theme_minimal(base_size = 12) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
legend.title = ggplot2::element_blank(),
legend.position="none"
)
barplot_data <- attribution_data %>%
dplyr::filter(label==0) %>%
dplyr::arrange(attribution) %>%
top_n(10) %>%
dplyr::mutate(label= as.character(label))
ggplot2::ggplot(barplot_data, ggplot2::aes(x = attribution, y = reorder(input, attribution),
fill = label)) +
ggplot2::geom_bar(
stat = "identity",
alpha = 0.6
) +
ggplot2::scale_fill_manual(
values = c("1" = "#ff7f0e", "0" = "#1f77b4")
) +
ggplot2::labs(
x = "Attribution score",
y = "Top 10 tokens",
title = "Token attributions for class 'Positive'"
) +
ggplot2::theme_minimal(base_size = 12) +
ggplot2::theme(
plot.title = ggplot2::element_text(face = "bold", size = 12),
legend.title = ggplot2::element_blank(),
legend.position="none"
)
runApp()
runApp()
?top_n
runApp()
shiny::runApp()
shiny::runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
?position_dodge
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
db_path <- system.file("extdata", "eir_data.sqlite", package = "DNBCFoodTextClassifier")
con <- DBI::dbConnect(RSQLite::SQLite(), db_path)
runApp()
classif_type="Broad Categories"
food_category="Alcohol"
if (!exists("food_category") || is.null(food_category) || food_category == "" || is.na(food_category)) {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type, "'")
} else {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type,
"' AND name_exp = '", food_category, "'")
}
category_id <- DBI::dbGetQuery(con, q1)$category_id
q2 <- paste0("SELECT * FROM predictions WHERE category_id IN (", paste(category_id, collapse = ","),")")
pred_data <- DBI::dbGetQuery(con, q2) %>%
dplyr::mutate(true_label_factor = factor(true_label, levels = c(0, 1),
labels = c("Negative", "Positive")))
View(pred_data)
if (!exists("food_category") || is.null(food_category) || food_category == "" || is.na(food_category)) {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type, "'")
} else {
q1 <- paste0("SELECT category_id FROM categories WHERE type = '", classif_type,
"' AND name_exp = '", food_category, "'")
}
category_id <- DBI::dbGetQuery(con, q1)$category_id
q2 <- paste0("SELECT * FROM metrics WHERE category_id IN (", paste(category_id, collapse = ","),")")
metric_data <- DBI::dbGetQuery(con, q2)
if (!exists("food_category") || is.null(food_category) || food_category == "" || is.na(food_category)) {
q1 <- paste0("SELECT category_id,name_exp FROM categories WHERE type = '", classif_type, "'")
} else {
q1 <- paste0("SELECT category_id,name_exp FROM categories WHERE type = '", classif_type,
"' AND name_exp = '", food_category, "'")
}
category_mapper <- DBI::dbGetQuery(con, q1)
scatter_plot_data <- pred_data %>%
dplyr::mutate(
pred_class = ifelse(predicted_value_1 > predicted_value_0, "Positive", "Negative")
) %>%
dplyr::group_by(category_id, true_label_factor, pred_class) %>%
dplyr::summarise(true_positives = n(), .groups = "drop") %>%
dplyr::filter(true_label_factor == "Positive", pred_class == "Positive") %>%
dplyr::select(category_id, true_positives) %>%
dplyr::full_join(metric_data, by = "category_id") %>%
dplyr::full_join(categ_data, by = "category_id") %>%
tidyr::pivot_longer(
cols = c(mcc, acc, roc_auc_macro, ap_macro),
names_to = "metric",
values_to = "value"
)
View(category_mapper)
categ_data <- category_mapper
scatter_plot_data <- pred_data %>%
dplyr::mutate(
pred_class = ifelse(predicted_value_1 > predicted_value_0, "Positive", "Negative")
) %>%
dplyr::group_by(category_id, true_label_factor, pred_class) %>%
dplyr::summarise(true_positives = n(), .groups = "drop") %>%
dplyr::filter(true_label_factor == "Positive", pred_class == "Positive") %>%
dplyr::select(category_id, true_positives) %>%
dplyr::full_join(metric_data, by = "category_id") %>%
dplyr::full_join(categ_data, by = "category_id") %>%
tidyr::pivot_longer(
cols = c(mcc, acc, roc_auc_macro, ap_macro),
names_to = "metric",
values_to = "value"
)
View(scatter_plot_data)
View(pred_data)
View(metric_data)
head(metric_data)
runApp()
runApp()
View(scatter_plot_data)
View(categ_data)
runApp()
runApp()
shiny::runApp()
?theme
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
shiny::runApp()
shiny::runApp()
